<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¼šè®®è®°å½•ï½œLIUBC åŒå·¥å¹³å°</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Noto Sans SC",Arial; margin:0; background:#f6f7fb; color:#111;}
    header{background:#fff; border-bottom:1px solid #e9e9ef;}
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{width:44px; height:44px; border-radius:12px; background:#4f74ff;}
    .h1{font-size:18px; font-weight:700;}
    .sub{font-size:12px; color:#666; margin-top:2px;}
    nav a{display:inline-block; padding:8px 12px; border:1px solid #e5e7ef; border-radius:999px; text-decoration:none; color:#222; background:#fff; margin-left:8px;}
    nav a:hover{background:#f1f4ff;}
    .card{background:#fff; border:1px solid #e9e9ef; border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.04);}
    .grid{display:grid; grid-template-columns:1fr; gap:12px;}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input,select{padding:10px 12px; border:1px solid #e5e7ef; border-radius:12px; background:#fff; font-size:14px;}
    .list{margin-top:12px; display:grid; gap:10px;}
    .item{border:1px solid #eef0f6; border-radius:14px; padding:12px;}
    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:#666; font-size:12px;}
    .title{font-size:16px; font-weight:700; margin:6px 0;}
    .summary{color:#333; margin:6px 0 10px; line-height:1.5;}
    .tag{font-size:12px; padding:3px 8px; background:#f1f4ff; border:1px solid #dfe6ff; border-radius:999px; color:#2a43c7;}
    .btn{display:inline-block; padding:8px 12px; border-radius:12px; border:1px solid #e5e7ef; text-decoration:none; color:#222; background:#fff; margin-right:8px;}
    .btn.primary{background:#4f74ff; border-color:#4f74ff; color:#fff;}
    footer{color:#666; font-size:12px; padding:16px 0;}
    .hint{color:#666; font-size:13px; line-height:1.6;}
    .err{color:#b00020; background:#fff2f2; border:1px solid #ffd6d6; padding:10px 12px; border-radius:12px;}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="h1">LIUBC åŒå·¥å¹³å°ï½œä¼šè®®è®°å½•</div>
        <div class="sub">å…¥å£åˆ—è¡¨ + é™„ä»¶ä¸‹è½½ï¼ˆPDF/Wordï¼‰</div>
      </div>
    </div>
    <nav>
      <a href="./index.html">é¦–é¡µ</a>
      <a href="./announcements.html">å…¬å‘Š</a>
      <a href="./calendar.html">æ—¥ç¨‹</a>
      <a href="./files.html">æ–‡ä»¶åº“</a>
      <a href="./inventory.html">åº“å­˜ç›˜ç‚¹</a>
      <a href="./departments.html">éƒ¨é—¨</a>
      <a href="./admin.html">ä¸»å¸­é¢æ¿</a>
    </nav>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div class="controls">
      <input id="q" placeholder="æœç´¢ï¼šæ ‡é¢˜ / æ‘˜è¦ / æ ‡ç­¾â€¦" style="min-width:260px; flex:1;" />
      <select id="dept">
        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
      </select>
      <select id="year">
        <option value="">å…¨éƒ¨å¹´ä»½</option>
      </select>
      <button id="reload" class="btn">é‡æ–°åŠ è½½</button>
    </div>
    <p class="hint">
      âœ… æ–°å¢ä¼šè®®ï¼šåªéœ€è¦ä¸Šä¼ é™„ä»¶åˆ° <code>minutes/</code>ï¼Œå†åœ¨ <code>data/minutes.json</code> é‡Œæ–°å¢ä¸€æ¡è®°å½•å³å¯ã€‚<br/>
      âœ… æ¯æ¡è®°å½•æä¾›ï¼šæ‰“å¼€ï¼ˆæ–°æ ‡ç­¾é¡µï¼‰+ ä¸‹è½½ï¼ˆè‹¥æµè§ˆå™¨æ”¯æŒï¼‰ã€‚
    </p>
    <div id="msg"></div>
    <div id="list" class="list"></div>
  </section>

  <footer>LIUBCï½œMinutes â€¢ æœ¬é¡µæ•°æ®æ¥æºï¼š<code>data/minutes.json</code></footer>
</main>

<script>
const DATA_URL = "./data/minutes.json";

function el(tag, attrs={}, html=""){
  const e = document.createElement(tag);
  for(const k in attrs){
    if(k === "class") e.className = attrs[k];
    else e.setAttribute(k, attrs[k]);
  }
  if(html) e.innerHTML = html;
  return e;
}

function safeText(s){ return (s ?? "").toString(); }

async function loadData(){
  const r = await fetch(DATA_URL + "?v=" + Date.now());
  if(!r.ok) throw new Error("è¯»å– minutes.json å¤±è´¥ï¼ˆè¯·ç¡®è®¤ data/minutes.json å·²æäº¤åˆ° GitHubï¼‰");
  const data = await r.json();
  if(!Array.isArray(data)) throw new Error("minutes.json æ ¼å¼é”™è¯¯ï¼šéœ€è¦æ˜¯æ•°ç»„ []");
  return data.map(x => ({
    date: safeText(x.date),
    title: safeText(x.title),
    department: safeText(x.department),
    tags: Array.isArray(x.tags) ? x.tags.map(safeText) : [],
    summary: safeText(x.summary),
    file: safeText(x.file)
  }));
}

function buildFilters(items){
  const deptSel = document.getElementById("dept");
  const yearSel = document.getElementById("year");

  const depts = Array.from(new Set(items.map(i=>i.department).filter(Boolean))).sort();
  const years = Array.from(new Set(items.map(i=> (i.date||"").slice(0,4)).filter(y=>/^\d{4}$/.test(y)))).sort().reverse();

  deptSel.innerHTML = `<option value="">å…¨éƒ¨éƒ¨é—¨</option>` + depts.map(d=>`<option value="${d}">${d}</option>`).join("");
  yearSel.innerHTML = `<option value="">å…¨éƒ¨å¹´ä»½</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
}

function render(items){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const dept = document.getElementById("dept").value;
  const year = document.getElementById("year").value;

  let filtered = items.slice();

  if(dept) filtered = filtered.filter(i => i.department === dept);
  if(year) filtered = filtered.filter(i => (i.date||"").startsWith(year));

  if(q){
    filtered = filtered.filter(i => {
      const hay = [
        i.title, i.summary, i.department,
        ...(i.tags||[])
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  // æ—¥æœŸå€’åº
  filtered.sort((a,b) => (b.date||"").localeCompare(a.date||""));

  const list = document.getElementById("list");
  list.innerHTML = "";

  if(filtered.length === 0){
    list.appendChild(el("div",{class:"item"}, "æ²¡æœ‰åŒ¹é…çš„ä¼šè®®è®°å½•ã€‚"));
    return;
  }

  for(const i of filtered){
    const box = el("div",{class:"item"});
    const meta = el("div",{class:"meta"});
    meta.appendChild(el("span",{}, `ğŸ“… ${i.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰"}`));
    if(i.department) meta.appendChild(el("span",{}, `ğŸ·ï¸ ${i.department}`));
    box.appendChild(meta);

    box.appendChild(el("div",{class:"title"}, i.title || "ï¼ˆæœªå¡«æ ‡é¢˜ï¼‰"));

    if(i.tags?.length){
      const tags = el("div",{class:"meta"});
      i.tags.forEach(t => tags.appendChild(el("span",{class:"tag"}, t)));
      box.appendChild(tags);
    }

    if(i.summary) box.appendChild(el("div",{class:"summary"}, i.summary));

    const actions = el("div",{});
    if(i.file){
      actions.appendChild(el("a",{class:"btn primary", href:i.file, target:"_blank", rel:"noopener"}, "æ‰“å¼€é™„ä»¶"));
      actions.appendChild(el("a",{class:"btn", href:i.file, download:""}, "ä¸‹è½½"));
    }else{
      actions.appendChild(el("span",{class:"hint"}, "ï¼ˆæœªæä¾›é™„ä»¶é“¾æ¥ï¼‰"));
    }
    box.appendChild(actions);

    list.appendChild(box);
  }
}

let CACHE = [];

async function init(){
  const msg = document.getElementById("msg");
  msg.innerHTML = "";
  try{
    CACHE = await loadData();
    buildFilters(CACHE);
    render(CACHE);
  }catch(e){
    msg.innerHTML = `<div class="err">âŒ ${e.message}</div>`;
  }
}

document.getElementById("q").addEventListener("input", ()=>render(CACHE));
document.getElementById("dept").addEventListener("change", ()=>render(CACHE));
document.getElementById("year").addEventListener("change", ()=>render(CACHE));
document.getElementById("reload").addEventListener("click", init);

init();
</script>
</body>
</html>
